digraph JANUS_ARCHITECTURE {
    // Layout: left-to-right for better aspect ratio
    rankdir=LR;
    node [fontname="Helvetica", fontsize=12, style=filled, fillcolor=white];
    edge [fontname="Helvetica", fontsize=10];
    compound=true;
    splines=true;
    nodesep=0.4;
    ranksep=1.0;

    // ===== ENTRY =====
    subgraph cluster_entry {
        label="Entry";
        labelloc=t;
        style=filled; fillcolor="#e8f5e9";

        user_msg [label="User\nmessage", shape=doublecircle, fillcolor="#c8e6c9"];
    }

    // ===== SKILL ROUTING (using-superpowers) =====
    subgraph cluster_routing {
        label="using-superpowers";
        labelloc=t;
        style=filled; fillcolor="#e3f2fd";

        skill_check [label="Skill\napplies?", shape=diamond];
        invoke [label="Invoke skill", shape=box];
        follow [label="Follow skill", shape=box];
        respond [label="Respond", shape=doublecircle, fillcolor="#c8e6c9"];
    }

    // ===== TRIGGERS (decides which skill) =====
    subgraph cluster_triggers {
        label="Triggers";
        labelloc=t;
        style=filled; fillcolor="#fff3e0";

        trigger_impl [label="Implementation?", shape=diamond];
        trigger_confused [label="Confused?", shape=diamond, fillcolor="#ffccbc"];
        trigger_re [label="RE analysis?", shape=diamond];
        trigger_interop [label="Writing\ninterop?", shape=diamond];
    }

    // ===== LANGUAGE SELECTION =====
    subgraph cluster_lang {
        label="Language Selection";
        labelloc=t;
        style=filled; fillcolor="#fff9c4";

        new_code [label="New\ncode?", shape=diamond];
        ext_pl [label="Extending\n.pl?", shape=diamond];
        ext_py [label="Extending\n.py?", shape=diamond];
        backtrack [label="Need\nbacktrack?", shape=diamond];
        ml_data [label="Need\nML/data?", shape=diamond];

        prolog [label="Prolog", shape=box, fillcolor="#c8e6c9"];
        python [label="Python", shape=box, fillcolor="#bbdefb"];
        hybrid [label="Hybrid", shape=box, fillcolor="#e1bee7"];
    }

    // ===== JANUS-REASONING =====
    subgraph cluster_reasoning {
        label="janus-reasoning";
        labelloc=t;
        style=filled; fillcolor="#f3e5f5";

        reason_entry [label="Enter\nprotocol", shape=doublecircle, fillcolor="#ce93d8"];

        semantic [label="Analyze\nsemantics", shape=box];
        symbolic [label="Reason\nsymbolically", shape=box];
        compare [label="Agree?", shape=diamond];

        derived [label="Derived?", shape=diamond];
        paradigm_fit [label="Paradigm\nfits?", shape=diamond];

        exit_ok [label="Exit to\nTDD/Debug", shape=doublecircle, fillcolor="#c8e6c9"];
        switch [label="Switch\nparadigm", shape=box, fillcolor="#fff9c4"];
        escalate [label="Escalate", shape=octagon, fillcolor=red, fontcolor=white];
    }

    // ===== JANUS-INTEROP =====
    subgraph cluster_interop {
        label="janus-interop";
        labelloc=t;
        style=filled; fillcolor="#b2dfdb";

        safety_entry [label="Safety\nchecklist", shape=doublecircle, fillcolor="#80cbc4"];

        pre_check [label="Pre-exec\nchecks", shape=note, fillcolor="#e0f2f1"];
        write_code [label="Write\ncode", shape=box];
        post_check [label="Post-exec\nverify", shape=note, fillcolor="#e0f2f1"];

        violation [label="Violation?", shape=diamond];
        fix [label="Fix", shape=box, fillcolor="#ffccbc"];
        safe [label="Safe", shape=doublecircle, fillcolor="#c8e6c9"];
    }

    // ===== JANUS-REVERSE-ENGINEERING =====
    subgraph cluster_re {
        label="janus-reverse-engineering";
        labelloc=t;
        style=filled; fillcolor="#e1f5fe";

        re_entry [label="Analyze\nbinary", shape=doublecircle, fillcolor="#81d4fa"];

        recognize [label="Recognize\npattern", shape=box];
        assert_kb [label="Assert to\nProlog KB", shape=box];
        query [label="?- contradiction(F,Why)", shape=plaintext];

        contra [label="Contradiction?", shape=diamond];
        resolve [label="Resolve", shape=box];
        retract [label="Retract", shape=box, fillcolor="#ffccbc"];
        present [label="Present\nclaim", shape=doublecircle, fillcolor="#c8e6c9"];
    }

    // ===== NEVER RULES =====
    subgraph cluster_never {
        label="NEVER";
        labelloc=t;
        style=filled; fillcolor="#ffcdd2";
        rank=same;

        never1 [label="Guess", shape=octagon, fillcolor=red, fontcolor=white];
        never2 [label="Multi-change", shape=octagon, fillcolor=red, fontcolor=white];
        never3 [label="Skip symbolic", shape=octagon, fillcolor=red, fontcolor=white];
        never4 [label="Claim if\ncontradicted", shape=octagon, fillcolor=red, fontcolor=white];
    }

    // ===== EDGES: Main Flow =====
    user_msg -> skill_check;
    skill_check -> invoke [label="yes"];
    skill_check -> respond [label="no"];
    invoke -> follow;
    follow -> trigger_impl;

    // ===== EDGES: Trigger Routing =====
    trigger_impl -> new_code [label="yes"];
    trigger_impl -> trigger_confused [label="no"];
    trigger_confused -> reason_entry [label="yes", color="#d32f2f", penwidth=2];
    trigger_confused -> trigger_re [label="no"];
    trigger_re -> re_entry [label="yes", color="#1976d2", penwidth=2];
    trigger_re -> trigger_interop [label="no"];
    trigger_interop -> safety_entry [label="yes", color="#00796b", penwidth=2];
    trigger_interop -> respond [label="no"];

    // ===== EDGES: Language Selection =====
    new_code -> ext_pl [label="yes"];
    new_code -> hybrid [label="no"];
    ext_pl -> prolog [label="yes"];
    ext_pl -> ext_py [label="no"];
    ext_py -> python [label="yes"];
    ext_py -> backtrack [label="no"];
    backtrack -> prolog [label="yes"];
    backtrack -> ml_data [label="no"];
    ml_data -> python [label="yes"];
    ml_data -> hybrid [label="no"];

    prolog -> safety_entry;
    python -> safety_entry;
    hybrid -> safety_entry;

    // ===== EDGES: Reasoning =====
    reason_entry -> semantic;
    semantic -> symbolic;
    symbolic -> compare;
    compare -> derived [label="yes"];
    compare -> semantic [label="no\ninvestigate"];
    derived -> paradigm_fit [label="yes"];
    derived -> semantic [label="no\nredo"];
    paradigm_fit -> exit_ok [label="yes"];
    paradigm_fit -> switch [label="no"];
    switch -> safety_entry [label="< 2"];
    switch -> escalate [label=">= 2"];

    exit_ok -> respond [style=dashed];

    // ===== EDGES: Safety =====
    safety_entry -> pre_check [style=dotted, arrowhead=none];
    safety_entry -> write_code;
    write_code -> post_check [style=dotted, arrowhead=none];
    write_code -> violation;
    violation -> fix [label="yes"];
    violation -> safe [label="no"];
    fix -> violation;

    safe -> respond [style=dashed];

    // ===== EDGES: RE =====
    re_entry -> recognize;
    recognize -> assert_kb;
    assert_kb -> safety_entry [label="before query", style=dashed, color="#00796b"];
    assert_kb -> query;
    query -> contra;
    contra -> present [label="none"];
    contra -> resolve [label="resolvable"];
    contra -> retract [label="unresolvable"];
    resolve -> query;
    retract -> recognize [label="retry"];
    retract -> reason_entry [label="stuck", color="#7b1fa2", penwidth=2];

    present -> respond [style=dashed];
}
